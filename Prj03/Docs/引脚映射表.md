# SPI+DMA引脚分配表

## GPIO冲突检查结果

### 检查状态 ✓
- [x] GPIO24-27：**未被占用**（可用于SPIB）
- [x] GPIO54-57：**未被占用**（可用于SPIA）
- [x] GPIO16：**未被占用**（可用于DRDY-XINT1）
- [x] GPIO8：**未被占用**（可用于RESET）
- [x] GPIO9：**未被占用**（可用于LDAC）

### 已占用GPIO
| GPIO | 当前用途 | 位置 |
|------|---------|------|
| 0-5 | LED控制 | drv_system.c |
| 8-9 | AD5754控制 | drv_ads1278.c, drv_ad5754.c |
| 10-18 | ADS1278控制 | drv_ads1278.c |
| 24-27 | SPIB (AD5754) | drv_spi.c |
| 37 | 测试引脚 | drv_system.c |
| 54-57 | SPIA (ADS1278) | drv_spi.c |
| 147 | FPGA看门狗 | drv_system.c |

---

## 完整引脚分配方案

### 1. SPIA - ADS1278 (ADC)

#### SPI信号引脚

| GPIO | 信号名 | 方向 | MUX | 功能描述 | 备注 |
|------|--------|------|-----|---------|------|
| **54** | SPISIMOA | 双向 | 6 | SPI-A MOSI | 主→从数据 |
| **55** | SPISOMIA | 双向 | 6 | SPI-A MISO | 从→主数据 |
| **56** | SPICLKA | 输出 | 6 | SPI-A时钟 | 10MHz |

#### ADS1278控制信号

| GPIO | 信号名 | 方向 | MUX | 功能描述 | 备注 |
|------|--------|------|-----|------------|--------------------------------|
| **57** | DRDY (XINT2) | 输入 | 0 | 数据就绪中断 | 连接到XINT2，下降沿触发 |
| **58** | ~~CS (备用)~~ | ~~输出~~ | ~~0~~ | ~~片选 (可选)~~ | **未使用**（CS硬件固定拉低） |

**注意**: 以下ADS1278配置引脚已在**PCB上硬件固定**，无需软件配置：
- **MODE[1:0]**: 硬件固定为 `01` (高分辨率模式)
- **FORMAT[2:0]**: 硬件固定为 `001` (SPI, TDM模式)
- **SYNC**: 硬件上拉 (连续采样模式)
- **PWDN**: 硬件上拉 (正常工作模式)
- **CS**: 硬件固定拉低 (芯片始终选中)

---

### 2. SPIB - AD5754 (DAC)

| GPIO | 信号名 | 方向 | MUX | 功能描述 | 备注 |
|------|--------|------|-----|---------|------|
| **24** | SPISIMOB | 双向 | 6 | SPI-B MOSI | 主→从数据 |
| **25** | SPISOMIB | 双向 | 6 | SPI-B MISO | 从→主数据（读回） |
| **26** | SPICLKB | 输出 | 6 | SPI-B时钟 | 10MHz |
| **27** | GPIO27 | 输出 | 0 | 片选CS (软件控制) | 低有效 |

#### AD5754控制信号

| GPIO | 信号名 | 方向 | MUX | 功能描述 | 电平 |
|------|--------|------|-----|---------|------|
| **8** | RESET | 输出 | 0 | 硬件复位 | 低复位，≥10us |
| **9** | LDAC | 输出 | 0 | 锁存DAC输出 | 可选，脉冲≥20ns |

---

## GPIO配置细节

### SPIA引脚配置代码
```c
// SPIA SPI功能引脚 (GPIO54-56)
// 参考：Drivers/drv_spi.c - Drv_SPI_GPIO_Config()

// GPIO54: SPISIMOA (MOSI - 主机输出)
GPIO_SetupPinMux(54, GPIO_MUX_CPU1, 6);
GPIO_SetupPinOptions(54, GPIO_OUTPUT, GPIO_PUSHPULL);
GpioCtrlRegs.GPBPUD.bit.GPIO54 = 0;    // 使能上拉
GpioCtrlRegs.GPBQSEL2.bit.GPIO54 = 3;  // 同步采样

// GPIO55: SPISOMIA (MISO - 主机输入)
GPIO_SetupPinMux(55, GPIO_MUX_CPU1, 6);
GPIO_SetupPinOptions(55, GPIO_INPUT, GPIO_PUSHPULL);
GpioCtrlRegs.GPBPUD.bit.GPIO55 = 0;    // 使能上拉
GpioCtrlRegs.GPBQSEL2.bit.GPIO55 = 3;  // 同步采样

// GPIO56: SPICLKA (时钟 - 主机输出)
GPIO_SetupPinMux(56, GPIO_MUX_CPU1, 6);
GPIO_SetupPinOptions(56, GPIO_OUTPUT, GPIO_PUSHPULL);

/* 注意：GPIO57不在此配置
 * - GPIO57用于ADS1278的DRDY输入信号（由Drv_ADS1278_GPIO_Config配置）
 * - ADS1278的CS引脚在PCB硬件上已固定拉低，不需要GPIO控制
 */
```

### SPIB引脚配置代码
```c
// SPIB SPI功能引脚 (GPIO24-26)
// 参考：Drivers/drv_spi.c - Drv_SPI_GPIO_Config()

// GPIO24: SPISIMOB (MOSI - 主机输出)
GPIO_SetupPinMux(24, GPIO_MUX_CPU1, 6);
GPIO_SetupPinOptions(24, GPIO_OUTPUT, GPIO_PUSHPULL);
GpioCtrlRegs.GPAPUD.bit.GPIO24 = 0;    // 使能上拉
GpioCtrlRegs.GPAQSEL2.bit.GPIO24 = 3;  // 同步采样

// GPIO25: SPISOMIB (MISO - 主机输入)
GPIO_SetupPinMux(25, GPIO_MUX_CPU1, 6);
GPIO_SetupPinOptions(25, GPIO_INPUT, GPIO_PUSHPULL);
GpioCtrlRegs.GPAPUD.bit.GPIO25 = 0;    // 使能上拉
GpioCtrlRegs.GPAQSEL2.bit.GPIO25 = 3;  // 同步采样

// GPIO26: SPICLKB (时钟 - 主机输出)
GPIO_SetupPinMux(26, GPIO_MUX_CPU1, 6);
GPIO_SetupPinOptions(26, GPIO_OUTPUT, GPIO_PUSHPULL);

// GPIO27: CS片选 (GPIO模式，手动控制)
GPIO_SetupPinMux(27, GPIO_MUX_CPU1, 0);  // GPIO模式
GPIO_SetupPinOptions(27, GPIO_OUTPUT, GPIO_PUSHPULL);
GpioDataRegs.GPASET.bit.GPIO27 = 1;      // 初始高电平（未选中）
```

### ADS1278控制引脚配置代码
```c
// 参考：Drivers/drv_ads1278.c - Drv_ADS1278_GPIO_Config()

// DRDY (GPIO57) - 配置为XINT2中断输入
GPIO_SetupPinMux(57, GPIO_MUX_CPU1, 0);  // GPIO模式
GPIO_SetupPinOptions(57, GPIO_INPUT, GPIO_PULLUP | GPIO_SYNC);
GpioCtrlRegs.GPBQSEL2.bit.GPIO57 = 0;  // 同步到SYSCLKOUT

// 配置为XINT2（外部中断2）
GPIO_SetupXINT2Gpio(57);

/* 注意：以下ADS1278控制引脚已在PCB硬件上固定连接，无需软件配置：
 * - MODE[1:0]   : 硬件固定为 01 (高分辨率模式)
 * - FORMAT[2:0] : 硬件固定为 001 (SPI模式)
 * - SYNC        : 硬件上拉至IOVDD (连续采样模式)
 * - PWDN        : 硬件上拉至IOVDD (正常工作)
 * - CLKDIV      : 硬件固定（27MHz不分频时接IOVDD）
 * - DIN         : 硬件接GND（单片应用）
 * - CS          : 硬件固定拉低（芯片始终选中）
 */
```

### AD5754控制引脚配置代码
```c
// RESET (GPIO8)
GPIO_SetupPinMux(8, GPIO_MUX_CPU1, 0);
GPIO_SetupPinOptions(8, GPIO_OUTPUT, GPIO_PUSHPULL);
GpioDataRegs.GPASET.bit.GPIO8 = 1;  // 初始高电平

// LDAC (GPIO9) - 可选
GPIO_SetupPinMux(9, GPIO_MUX_CPU1, 0);
GPIO_SetupPinOptions(9, GPIO_OUTPUT, GPIO_PUSHPULL);
GpioDataRegs.GPASET.bit.GPIO9 = 1;  // 初始高电平
```

---

## DMA通道分配

| DMA通道 | 触发源 | 方向 | 缓冲区 | 大小 | 优先级 |
|---------|--------|------|--------|------|--------|
| **CH1** | SPIA RX (110) | SPIRXBUF→RAM | adc_rx_ping/pong | 24字节 | 最高 |
| **CH2** | SPIA TX (109) | RAM→SPITXBUF | dummy_tx | 24字节 | 高 |
| **CH5** | SPIB TX (111) | RAM→SPITXBUF | dac_tx | 12字节 | 中 |
| **CH6** | SPIB RX (112) | SPIRXBUF→RAM | dac_rx | 12字节 | 低 |

---

## 中断优先级分配

| 中断源 | PIE组 | PIE位 | CPU INT | 优先级 | 说明 |
|--------|-------|-------|---------|--------|------|
| **DRDY (XINT2, GPIO57)** | PIE1 | INTx5 | INT1 | 最高 | ADC数据就绪（下降沿触发） |
| **DMA CH1** | PIE7 | INTx1 | INT7 | 高 | SPIA RX完成 |
| **DMA CH2** | PIE7 | INTx2 | INT7 | 高 | SPIA TX完成 |
| **DMA CH5** | PIE7 | INTx5 | INT7 | 中 | SPIB TX完成 |
| **DMA CH6** | PIE7 | INTx6 | INT7 | 低 | SPIB RX完成 |

---

## 硬件连接参考

### ADS1278连接
```
DSP F28377D         ADS1278IPAPR
-----------         -------------
GPIO54 (MOSI) ----> DIN
GPIO55 (MISO) <---- DOUT
GPIO56 (CLK)  ----> SCLK
硬件固定GND   ----> CS (硬件固定拉低，芯片始终选中)
GPIO57 (XINT2)<---- DRDY (数据就绪中断，下降沿触发)
硬件上拉3.3V  ----> SYNC (连续采样模式)
硬件上拉3.3V  ----> PWDN (正常工作模式)
硬件固定      ----> MODE0 (接IOVDD，高分辨率模式)
硬件固定      ----> MODE1 (接GND，高分辨率模式)
硬件固定      ----> FORMAT0 (接IOVDD，SPI模式)
硬件固定      ----> FORMAT1 (接GND，SPI模式)
硬件固定      ----> FORMAT2 (接GND，SPI模式)
硬件固定      ----> CLKDIV (根据时钟固定)
硬件固定GND   ----> DIN (单片应用)
3.3V          ----> DVDD, AVDD
GND           ----> DGND, AGND
```

**注意**：大部分控制引脚已在PCB硬件上固定，软件仅需配置GPIO57为DRDY中断输入。

### AD5754连接
```
DSP F28377D         AD5754RBREZ
-----------         ------------
GPIO24 (MOSI) ----> DIN
GPIO25 (MISO) <---- SDO
GPIO26 (CLK)  ----> SCLK
GPIO27 (CS)   ----> SYNC (低有效)
GPIO8         ----> RESET (低有效)
GPIO9         ----> LDAC (可选)
3.3V          ----> DVCC
GND           ----> DGND
外部参考电压  ----> VREFIN
```

---

## 注意事项

1. **电平兼容性**：
   - F28377D IO输出电平：3.3V CMOS
   - ADS1278 IO接受电平：DVDD兼容（2.7V-5.5V）
   - AD5754 IO接受电平：DVCC兼容（2.7V-5.5V）
   - ✓ 直接连接无需电平转换

2. **上拉/下拉配置**：
   - SPI总线引脚：内部上拉使能（避免浮空）
   - CS引脚：初始输出高电平（非选中状态）
   - DRDY引脚：内部上拉使能（避免误触发）

3. **QSEL设置**：
   - 所有GPIO输入采用同步模式（QSEL=SYNC）
   - 同步周期：3个SYSCLK周期（避免亚稳态）

4. **PCB布线建议**：
   - SPICLK走线尽量短，控制在5cm内
   - MOSI/MISO差分走线，阻抗匹配
   - CS信号走线靠近芯片，避免串扰
   - DRDY信号独立走线，避免与时钟交叉

---

**最后更新**: 2025-10-20  
**审核状态**: GPIO冲突检查通过 ✓

