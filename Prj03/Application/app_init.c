/*******************************************************************************
 * 文件名：app_init.c
 * 描述：  应用初始化实现（3层架构：Drivers → Framework → Application）
 * 作者：  Auto-generated
 * 日期：  2025-10-20
 * 版本：  v2.1 - 重构SPI/DMA初始化到驱动层
 ******************************************************************************/

#include "app_init.h"
#include "app_task.h"
#include "../Drivers/drv_system.h"
#include "../Drivers/drv_watchdog.h"
#include "../Drivers/drv_timer.h"
#include "../Drivers/drv_led.h"
#include "../Drivers/drv_emif.h"
#include "../Drivers/drv_spi.h"
#include "../Drivers/drv_dma.h"
#include "../Drivers/drv_ads1278.h"
#include "../Drivers/drv_ad5754.h"
#include "../Framework/task_scheduler.h"

/******************************************************************************
 * 函数实现
 ******************************************************************************/

/**
 * @brief  应用初始化
 * @note   架构说明（v2.5更新为9个阶段）：
 *         1. Drivers层初始化：所有硬件资源（System/Timer/LED/EMIF）
 *         2. SPI/DMA驱动初始化：通信硬件资源 + DMA通道配置
 *         3. 芯片驱动初始化：外部芯片驱动（仅配置GPIO/中断/寄存器）
 *         3.5. DMA回调注册：将芯片回调注册到DMA层（v2.5新增）
 *         4. Framework层初始化：任务调度器
 *         5. 注册应用任务
 *         6. Application层参数配置：业务逻辑参数
 *         7. 使能中断
 *         8. 启动看门狗
 */
void App_Init(void)
{
    //========================================================================
    // 阶段1：基础驱动层初始化（通用硬件资源）
    //========================================================================
    Drv_System_Init();      // 系统初始化（时钟200MHz、GPIO、PIE）
    Drv_Timer_Init();       // Timer0初始化（100us周期定时器）
    Drv_LED_Init();         // LED初始化（GPIO0-5）
    Drv_EMIF_Init();        // EMIF初始化（外部存储器接口）
    
    //========================================================================
    // 阶段2：SPI/DMA驱动初始化（通信硬件资源）
    //========================================================================
    Drv_SPI_GPIO_Config();  // SPI GPIO配置（SPIA/SPIB引脚）
    Drv_SPIA_Init();        // SPIA初始化（ADS1278专用，10MHz、Mode1）
    Drv_SPIB_Init();        // SPIB初始化（AD5754专用，10MHz、Mode1）
    Drv_DMA_Init();         // DMA初始化（CH1/2:SPIA, CH5/6:SPIB）
    
    //========================================================================
    // 阶段3：外部芯片驱动初始化（依赖SPI/DMA）
    // v2.5更新：芯片驱动仅配置GPIO/中断/寄存器，DMA回调在阶段3.5注册
    //========================================================================
    Drv_ADS1278_InitDefault();  // ADS1278 ADC初始化（8通道24位，仅配置GPIO+XINT2）
    Drv_AD5754_InitDefault();   // AD5754 DAC初始化（4通道16位，配置寄存器）
    
    //========================================================================
    // 阶段3.5：注册DMA回调（v2.5新增）
    // 说明：DMA通道在阶段2已配置，芯片在阶段3已初始化，现在注册回调
    //========================================================================
    Drv_DMA_RegisterCallback(DMA_CH1, (DMA_Callback_t)Drv_ADS1278_GetDMACallback());
    // AD5754无需DMA回调（同步传输，阻塞等待完成）
    
    //========================================================================
    // 阶段4：Framework层初始化
    //========================================================================
    Scheduler_Init();       // 任务调度器初始化
    
    //========================================================================
    // 阶段5：注册应用任务
    //========================================================================
    Scheduler_RegisterDataTask(App_Task_DataProcess);  // 注册数据处理任务（20ms）
    Scheduler_RegisterLED1Task(App_Task_LED1Blink);    // 注册LED1任务（1s）
    Scheduler_RegisterLED2Task(App_Task_LED2Blink);    // 注册LED2任务（3s）
    
    //========================================================================
    // 阶段6：应用层参数配置（非硬件初始化）
    //========================================================================
    App_Task_UserInit();    // 用户自定义配置（波形参数、滤波器等）
    
    //========================================================================
    // 阶段7：使能定时器中断（所有硬件就绪后启动）
    //========================================================================
    Drv_Timer_EnableInterrupt();
    
    //========================================================================
    // 阶段8：看门狗初始化（最后启动，确保所有初始化完成）
    //========================================================================
    Drv_Watchdog_Init();    // 看门狗初始化（检测复位原因并配置）
}

