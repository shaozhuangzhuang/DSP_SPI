/*******************************************************************************
 * 文件名：drv_watchdog.c
 * 描述：  看门狗驱动实现 - TMS320F28377D内部看门狗管理
 * 作者：  Auto-generated
 * 日期：  2025-10-21
 * 
 * 参考：TI官方示例
 *   C:\ti\c2000\C2000Ware_5_04_00_00\device_support\f2837xd\examples\cpu1\watchdog
 ******************************************************************************/

#include "drv_watchdog.h"

/******************************************************************************
 * 私有变量
 ******************************************************************************/
static Uint32 watchdog_reset_count = 0;     // 看门狗复位计数器
static Uint32 watchdog_service_count = 0;   // 喂狗操作计数器

/******************************************************************************
 * 函数实现
 ******************************************************************************/

/**
 * @brief  看门狗初始化
 */
void Drv_Watchdog_Init(void)
{
    volatile Uint16 temp;
    
    //========================================================================
    // 第一步：检测复位原因
    //========================================================================
    // 通过SCSR寄存器的WDOVERRIDE位判断是否为看门狗复位
    // 注意：SCSR寄存器需要整体读写以避免清除WDOVERRIDE位
    if(WdRegs.SCSR.bit.WDOVERRIDE == 1)
    {
        // 检测到看门狗复位事件
        watchdog_reset_count++;
        
        // 可选：通过LED指示看门狗复位事件
        // 例如：快速闪烁LED0三次
        // 或者：设置一个全局标志供上层应用处理
    }
    
    //========================================================================
    // 第二步：配置看门狗参数
    //========================================================================
    // 配置看门狗控制寄存器
    // WDCR结构：
    //   Bit 6 (WDDIS): 0 = 使能看门狗, 1 = 禁用看门狗
    //   Bit 5:3 (WDCHK): 101 = 校验位（固定）
    //   Bit 2:0 (WDPS): 110 = 预分频64
    // 
    // 看门狗启用配置
    // 完整值：0x002E = 0b00101110 (使能)
    //   - WDDIS=0 (使能)
    //   - WDCHK=101 (校验位)
    //   - WDPS=110 (预分频64)
    // 超时时间：约839ms
    EALLOW;
    WdRegs.WDCR.all = 0x002E;  // ✅ 启用看门狗
    EDIS;
    
    //========================================================================
    // 第三步：立即喂一次狗
    //========================================================================
    Drv_Watchdog_Service();
    
    // 超时时间计算：
    // WDCLK = INTOSC1 (10MHz) / 512 / WDPS
    // 对于WDPS=64: WDCLK = 10MHz / 512 / 64 ≈ 305Hz
    // 超时 = 256 / 305Hz ≈ 839ms
    // 喂狗频率：50Hz (20ms周期)
    // 安全裕量：839ms / 20ms ≈ 42倍 ✅
}

/**
 * @brief  看门狗喂狗服务
 * @note   参考官方ServiceDog()函数实现
 */
Uint16 Watchdog_Test = 0;
void Drv_Watchdog_Service(void)
{
    // 喂狗计数器递增（用于调试统计）
    watchdog_service_count++;
    if(Watchdog_Test == 0)
    {
        // 清除看门狗计数器（写入密钥序列）
        EALLOW;
        WdRegs.WDKEY.bit.WDKEY = 0x0055;
        WdRegs.WDKEY.bit.WDKEY = 0x00AA;
        EDIS;
    }
}

/**
 * @brief  看门狗喂狗 (Kick别名)
 * @note   为兼容main1.c中的调用提供别名函数
 */
void Drv_Watchdog_Kick(void)
{
    Drv_Watchdog_Service();
}

